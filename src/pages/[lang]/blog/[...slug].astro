---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import SocialLinks from '../../../components/SocialLinks.astro';
import { defaultLang, getDictionary, languages, type Lang } from '../../../i18n/ui';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => !data.draft);

	return posts.map((post) => {
		const siblings = posts.filter(
			(candidate) =>
				candidate.slug !== post.slug &&
				candidate.data.translationKey === post.data.translationKey
		);

		return {
			params: {
				lang: post.data.lang,
				slug: post.data.urlSlug,
			},
			props: {
				post,
				translations: siblings,
			},
		};
	});
}

type Props = {
	post: CollectionEntry<'blog'>;
	translations: CollectionEntry<'blog'>[];
};

const { post, translations } = Astro.props as Props;
const { Content } = await post.render();

const lang = (Astro.params.lang ?? defaultLang) as Lang;
const dictionary = getDictionary(lang);

const formattedDate = new Intl.DateTimeFormat(lang === 'es' ? 'es-ES' : 'en-US', {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
}).format(post.data.pubDate);

const updatedDate =
	post.data.updatedDate &&
	new Intl.DateTimeFormat(lang === 'es' ? 'es-ES' : 'en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
	}).format(post.data.updatedDate);

const alternateLinks = Object.fromEntries(
	Object.keys(languages).map((code) => {
		if (code === post.data.lang) {
			return [code, `/${code}/blog/${post.data.urlSlug}/`];
		}

		const match = translations.find((entry) => entry.data.lang === code);

		if (match) {
			return [code, `/${code}/blog/${match.data.urlSlug}/`];
		}

		return [code, `/${code}/blog/`];
	})
);
---

<Layout
	lang={lang}
	title={`${post.data.title} - ${dictionary.heroName}`}
	description={post.data.description || dictionary.siteDescription}
	alternateLinks={alternateLinks}
>
	<main class="py-8 sm:py-12">
		<article class="max-w-3xl space-y-8">
			<header class="pb-6">
				<p class="text-xs uppercase tracking-[0.4em] text-base-content/60">{dictionary.blogPageTitle}</p>
				<h1 class="mt-2 text-4xl font-semibold leading-tight sm:text-5xl text-balance">{post.data.title}</h1>
				<div class="mt-3 flex flex-wrap items-center gap-4 text-sm text-base-content/70">
					<div class="flex items-center gap-2">
						<span class="h-2 w-2 rounded-full bg-base-content/40"></span>
						<time datetime={post.data.pubDate.toISOString()}>{formattedDate}</time>
					</div>
					{updatedDate && (
						<div class="flex items-center gap-2">
							<span>â†º</span>
							<time datetime={post.data.updatedDate?.toISOString()}>
								{dictionary.updatedLabel} {updatedDate}
							</time>
						</div>
					)}
				</div>
				{post.data.tags && post.data.tags.length > 0 && (
					<div class="mt-4 flex flex-wrap gap-2">
						{post.data.tags.map((tag) => (
							<span class="badge badge-primary badge-soft" data-key={tag}>
								{tag}
							</span>
						))}
					</div>
				)}
				{post.data.description && (
					<p class="mt-4 text-lg text-base-content/65">{post.data.description}</p>
				)}
			</header>

			<section>
				<div class="prose lg:prose-lg prose-base-content dark:prose-invert max-w-none">
					<Content />
				</div>
			</section>

			<footer class="pt-6 border-t border-base-200/60">
				<div class="flex flex-col gap-3">
					<p class="text-base-content/70">{dictionary.connectWithMe}</p>
					<SocialLinks />
				</div>
			</footer>
		</article>
	</main>
</Layout>

